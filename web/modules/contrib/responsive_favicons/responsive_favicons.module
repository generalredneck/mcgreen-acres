<?php

/**
 * @file
 * Contains responsive_favicons.module.
 */

/**
 * Implements hook_help().
 */
function responsive_favicons_help($route_name) {
  switch ($route_name) {
    // Main module help for the responsive_favicons module.
    case 'help.page.responsive_favicons':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('This module adds the favicons generated by http://realfavicongenerator.net/ to your site. The responsive name comes from the fact that many devices are catered for including iPhone, Android, iPad, other tablets and desktops.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * Hook_page_attachments doesn't run for maintenance-page.
 */
function responsive_favicons_preprocess_maintenance_page(array &$variables) {
  responsive_favicons_page_attachments($variables);
}

/**
 * Implements hook_page_attachments().
 *
 * Adds responsive favicons to HTML head. A trailing newline is added to ensure
 * the next tag in the HTML head section starts on the next line.
 */
function responsive_favicons_page_attachments(array &$page) {
  $tags = \Drupal::service('responsive_favicons.manager')->loadAll();
  if (!empty($tags['links'])) {
    foreach ($tags['links'] as $link_attributes) {
      $page['#attached']['html_head_link'][] = [
        $link_attributes,
        TRUE,
      ];
    }
  }
  if (!empty($tags['metatags'])) {
    foreach ($tags['metatags'] as $index => $meta_attributes) {
      $meta = [
        '#tag' => 'meta',
        '#attributes' => $meta_attributes,
      ];
      $page['#attached']['html_head'][] = [$meta, 'responsive_favicons:' . $index];
    }
  }
}

/**
 * Implements hook_page_attachments_alter().
 *
 * Remove the stock Drupal favicon if it is present.
 */
function responsive_favicons_page_attachments_alter(array &$attachments) {
  $config = \Drupal::config('responsive_favicons.settings');
  if ($config->get('remove_default') && isset($attachments['#attached']['html_head_link'])) {
    foreach ($attachments['#attached']['html_head_link'] as $key => $link) {
      if (isset($link[0]['href']) && preg_match('#/(core|themes)/.*/favicon\.ico$#', $link[0]['href'])) {
        unset($attachments['#attached']['html_head_link'][$key]);
      }
    }
  }
}
